<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Cultural Virality Dashboard — Graph • Evolutionary • Automaton</title>
<meta name="viewport" content="width=device-width, initial-scale=1"/>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.1/normalize.min.css">
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

<script>
  window.MathJax = { tex: { inlineMath: [['\\(','\\)'], ['$', '$']] }, startup: { typeset: false } };
</script>
<script defer id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

<style>
  :root{
    --bg:#0f1116; --panel:#141822; --ink:#e8ecf3; --muted:#9aa4b2; --accent:#69b3ff; --accent2:#ffd166;
    --ok:#76e39c; --warn:#ffb86b; --bad:#ff6b6b;
  }
  html,body{height:100%;}
  body{background:var(--bg); color:var(--ink); font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;}
  h1{font-weight:700; margin:16px 0 8px}
  #app{display:grid; grid-template-rows:auto auto 1fr; gap:12px; padding:16px; max-width:1400px; margin:0 auto;}
  .topbar{display:flex; gap:16px; align-items:center; justify-content:space-between}
  .formulas{display:flex; gap:12px; flex-wrap:wrap; font-size:12px; color:var(--muted)}
  .chip{background:#141822; border:1px solid #1f2636; border-radius:8px; padding:8px 10px}
  .controls{display:grid; grid-template-columns:1.2fr 3fr; gap:12px}
  .panel{background:#141822; border:1px solid #1f2636; border-radius:12px; padding:12px}
  .grid2{display:grid; grid-template-columns:repeat(2,1fr); gap:12px}
  .row{display:flex; gap:12px; align-items:center; margin-bottom: 4px;}
  label{font-size:13px; color:var(--muted); min-width:140px}
  input[type=range]{width:100%}
  .value{font-variant-numeric:tabular-nums; color:var(--accent2)}
  .tabs{display:flex; gap:8px}
  .tab{padding:8px 12px; border-radius:10px; border:1px solid #252c40; background:#161b28; color:var(--muted); cursor:pointer}
  .tab.active{background:#1b2335; color:var(--ink); border-color:#2d364e}
  .views{position:relative; min-height:560px}
  .view{position:absolute; inset:0; display:none}
  .view.active{display:block}
  .split{display:grid; grid-template-columns:2fr 1fr; gap:12px; height:100%}
  .card{background:#121725; border:1px solid #1f2740; border-radius:10px; padding:10px; height:100%}
  .card h3{margin:4px 0 8px; font-size:14px; color:#dbe3ff}
  .metric{font-size:13px; color:var(--muted)}
  .metric b{color:#dbe3ff}
  .legend{font-size:12px; color:var(--muted)}
  .btn{background:#1a2134; border:1px solid #263154; padding:6px 10px; border-radius:8px; color:#dbe3ff; cursor:pointer}
  .btnrow{display:flex; gap:8px; flex-wrap:wrap}
  .badge{display:inline-block; padding:2px 8px; border-radius:8px; background:#1a2134; border:1px solid #263154; font-size:12px; color:#c9d3f2}
  .footer{color:#9aa4b2; font-size:12px; text-align:right; padding:6px 2px}
  /* Explicit dimensions */
  #graphSVG, #treeSVG, #evoSVG { width:100%; height:470px; display:block; }
  #gridCanvas { width:800px; height:480px; display:block; background:#0e1320; border-radius:8px }
  canvas{background:#0e1320; border-radius:8px}
  svg{background:#0e1320; border-radius:8px}
</style>
</head>

<body>
<div id="app" aria-live="polite">
  <div class="topbar">
    <div>
      <h1>Cultural Virality Dashboard</h1>
      <div style="color:#b8c1d9; font-size:12px">Three synchronized views (Macro, Meso, Micro) with content, cultural, and system parameters.</div>
    </div>
    <div class="formulas">
      <div class="chip">\(P=\sigma(\beta_0+\beta_v v+\beta_a a+\beta_{va}va+\beta_m M+\beta_g G_{out}+\beta_i In)\)</div>
      <div class="chip">\(S= \text{clamp}\big(0.1 + w_v\cdot \text{Pos}(v) + (1-w_v)\cdot \exp[-(a-a^*)^2/(2\sigma_a^2)],\,0,1\big)\)</div>
      <div class="chip">\( \alpha'=\eta\kappa P \)</div>
      <div class="chip">\( G=E-\lambda S \)</div>
    </div>
  </div>

  <div class="controls">
    <div class="panel">
      <h3>Content, Cultural, and System Parameters</h3>
      <div class="row"><label>Culture</label>
        <select id="culture">
          <option value="western">Western</option>
          <option value="eastern">Eastern</option>
          <option value="conflict">Conflict</option>
          <option value="science">Science</option>
          <option value="spain_like_inparty">Spain (in-party love)</option>
        </select>
      </div>
      <hr style="border-color: #1f2636; margin: 8px 0;">
      <div class="row"><label>v (valence)</label><input id="v" type="range" min="-1" max="1" step="0.01" value="-0.5"><span class="value" id="v_val">-0.50</span></div>
      <div class="row"><label>a (arousal)</label><input id="a" type="range" min="-1" max="1" step="0.01" value="0.7"><span class="value" id="a_val">0.70</span></div>
      <div class="row"><label title="Content denouncing norm violations or injustice (moral outrage)">Moralized Content (M)</label><input id="moral" type="checkbox"></div>
      <div class="row"><label title="Message directed at an external group (out-group)">Targeting Out-group (G_out)</label><input id="out" type="checkbox"></div>
      <div class="row"><label title="Message that praises or reinforces one's own group">In-group (In)</label><input id="in_" type="checkbox"></div>
      <hr style="border-color: #1f2636; margin: 8px 0;">
      <div class="row"><label>β₀</label><input id="b0" type="range" min="-2" max="2" step="0.01" value="0"><span class="value" id="b0_val">0.00</span></div>
      <div class="row"><label>βᵥ</label><input id="bv" type="range" min="-2" max="2" step="0.01" value="-0.5"><span class="value" id="bv_val">-0.50</span></div>
      <div class="row"><label>βₐ</label><input id="ba" type="range" min="-2" max="2" step="0.01" value="1.0"><span class="value" id="ba_val">1.00</span></div>
      <div class="row"><label>βᵥₐ</label><input id="bva" type="range" min="-2" max="2" step="0.01" value="0.8"><span class="value" id="bva_val">0.80</span></div>
      <div class="row"><label>βₘ (moral)</label><input id="bm" type="range" min="-2" max="2" step="0.01" value="0.6"><span class="value" id="bm_val">0.60</span></div>
      <div class="row"><label>βg (out-group)</label><input id="bg" type="range" min="-2" max="2" step="0.01" value="0.5"><span class="value" id="bg_val">0.50</span></div>
      <div class="row"><label>βᵢ (in-group love)</label><input id="bi" type="range" min="-2" max="2" step="0.01" value="0.2"><span class="value" id="bi_val">0.20</span></div>
       <hr style="border-color: #1f2636; margin: 8px 0;">
      <div class="row"><label>η (amplification)</label><input id="eta" type="range" min="0.5" max="2" step="0.01" value="1.2"><span class="value" id="eta_val">1.20</span></div>
      <div class="row"><label>κ (contagion base)</label><input id="kappa" type="range" min="0" max="1" step="0.01" value="0.6"><span class="value" id="kappa_val">0.60</span></div>
      <div class="row"><label>wᵥ (positivity weight)</label><input id="v_weight" type="range" min="0" max="1" step="0.01" value="0.60"><span class="value" id="v_weight_val">0.60</span></div>
      <div class="row"><label>a* (preferred arousal)</label><input id="a_pref" type="range" min="-1" max="1" step="0.01" value="0.20"><span class="value" id="a_pref_val">0.20</span></div>
      <div class="row"><label>σₐ (peak width)</label><input id="a_sigma" type="range" min="0.1" max="1.5" step="0.01" value="0.60"><span class="value" id="a_sigma_val">0.60</span></div>
      <div class="row"><label>λ (penalty)</label><input id="lambda" type="range" min="0" max="2" step="0.01" value="1.0"><span class="value" id="lambda_val">1.00</span></div>
    </div>

    <div class="panel">
      <h3>Simulation and Network Options</h3>
      <div class="grid2">
        <div>
          <h4>Graph and SEIR Dynamics</h4>
          <div class="row"><label>N nodes</label><input id="N" type="range" min="60" max="500" step="1" value="220"><span class="value" id="N_val">220</span></div>
          <div class="row"><label>Average degree</label><input id="kmean" type="range" min="4" max="20" step="1" value="10"><span class="value" id="kmean_val">10</span></div>
          <div class="row"><label>Heterogeneity</label>
            <select id="nettype">
              <option value="er">Erdős–Rényi (homog.)</option>
              <option value="pa">Preferential Attachment (scale-free)</option>
            </select>
          </div>
          <div class="row"><label>Seeds</label><input id="seeds" type="range" min="1" max="30" step="1" value="10"><span class="value" id="seeds_val">10</span></div>
          <div class="row"><label>ρ (E→I)</label><input id="rho" type="range" min="0" max="1" step="0.01" value="0.7"><span class="value" id="rho_val">0.70</span></div>
          <div class="row"><label>γ (I→R)</label><input id="gamma" type="range" min="0" max="1" step="0.01" value="0.2"><span class="value" id="gamma_val">0.20</span></div>
          <div class="row"><label>SS Threshold</label><input id="ss_thresh" type="range" min="0.5" max="0.99" step="0.01" value="0.80"><span class="value" id="ss_thresh_val">0.80</span></div>
        </div>
        <div>
            <h4>Automaton and Control</h4>
          <div class="row"><label>Grid width</label><input id="gridw" type="range" min="30" max="120" step="1" value="80"><span class="value" id="gridw_val">80</span></div>
          <div class="row"><label>Grid height</label><input id="gridh" type="range" min="20" max="90" step="1" value="50"><span class="value" id="gridh_val">50</span></div>
          <div class="row"><label>Algorithmic jump</label><input id="tele" type="range" min="0" max="50" step="1" value="8"><span class="value" id="tele_val">8</span></div>
          <div class="row"><label>Speed</label><input id="speed" type="range" min="0.1" max="3" step="0.1" value="1"><span class="value" id="speed_val">1.0×</span></div>
          <div class="btnrow" style="margin-top:24px">
            <button class="btn" id="regen" type="button">Regenerate Network</button>
            <button class="btn" id="resetAll" type="button">Reset All</button>
          </div>
        </div>
      </div>
      <div style="font-size:12px; color:#9aa4b2; margin-top:12px">The culture selector changes the system's sensitivity to valence/arousal and to moral and group signals. In <b>Western/Conflict</b>, the negative + high arousal combination and out-group attacks (βg) maximize shares, while in <b>Eastern/Science</b>, likability and diffusion favor positive and moderately-arousing content. The <b>Spain (in-party love)</b> preset illustrates contexts where praising one's own group (βᵢ·In) competes with or surpasses the effect of attacking an out-group.</div>
    </div>
  </div>

  <div class="tabs">
    <div class="tab active" data-tab="grafo">A) Graph (macro)</div>
    <div class="tab" data-tab="evolutivo">B) Evolutionary (meso)</div>
    <div class="tab" data-tab="automata">C) Automaton (micro)</div>
  </div>

  <div class="views">
    <div class="view active" id="view-grafo">
      <div class="split">
        <div class="card">
          <h3>Network and Cascade</h3>
          <div class="btnrow" style="margin-bottom:6px">
            <button class="btn" id="g_play"  type="button">▶ Play</button>
            <button class="btn" id="g_step"  type="button">Step</button>
            <button class="btn" id="g_pause" type="button">⏸ Pause</button>
            <button class="btn" id="g_reset" type="button">Reset</button>
            <span class="badge">States: S=gray, E=blue, I=yellow, R=red</span>
          </div>
          <div class="grid2" style="grid-template-columns:1.6fr 1fr; height:470px">
            <svg id="graphSVG"></svg>
            <svg id="treeSVG"></svg>
          </div>
        </div>
        <div class="card">
          <h3>Metrics (Graph)</h3>
          <div id="metrics" class="metric"></div>
          <canvas id="chartGI" height="170"></canvas>
          <div class="legend">Curves: I(t) & C(t). Superspreader and VPS summary.</div>
        </div>
      </div>
    </div>

    <div class="view" id="view-evolutivo">
      <div class="split">
        <div class="card">
          <h3>"Meme Breeder" — v–a Plane</h3>
          <div class="btnrow" style="margin-bottom:6px">
            <button class="btn" id="e_step"  type="button">Generation +1</button>
            <button class="btn" id="e_run"   type="button">Auto</button>
            <button class="btn" id="e_pause" type="button">Pause</button>
            <button class="btn" id="e_reset" type="button">Reset</button>
            <span class="badge">F₁: Reach (≈ f(R₀)) • F₂: −G(x)</span>
          </div>
          <svg id="evoSVG"></svg>
        </div>
        <div class="card">
          <h3>Metrics (Evolutionary)</h3>
          <div id="e_metrics" class="metric"></div>
          <canvas id="chartPareto" height="180"></canvas>
          <div class="legend">Pareto front and elite trajectory.</div>
        </div>
      </div>
    </div>

    <div class="view" id="view-automata">
      <div class="split">
        <div class="card">
          <h3>S/E/I/R Cellular Automaton</h3>
          <div class="btnrow" style="margin-bottom:6px">
            <button class="btn" id="c_play"  type="button">▶ Play</button>
            <button class="btn" id="c_step"  type="button">Step</button>
            <button class="btn" id="c_pause" type="button">⏸ Pause</button>
            <button class="btn" id="c_reset" type="button">Reset</button>
            <span class="badge">Teleportation = random jumps (recommendation)</span>
          </div>
          <canvas id="gridCanvas"></canvas>
        </div>
        <div class="card">
          <h3>S(t), E(t), I(t), R(t) Curves</h3>
          <canvas id="chartSER" height="240"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="footer">Virality engine based on social psychology and epidemiological models.</div>
</div>

<script>
/* ===================== Utilities ===================== */
const el = id => document.getElementById(id);
const fmt = (x,d=2)=> (Math.round(x*10**d)/10**d).toFixed(d);
const clamp = (x,a,b)=> Math.max(a, Math.min(b, x));
const rand = (()=>{ let s=1234567; return { seed:(x)=>{s=x;}, r:()=> (s=(s*1664525+1013904223)>>>0,(s>>>8)/16777216) }; })();
function sigma(z){ return 1/(1+Math.exp(-z)); }
function resizeCanvasToDisplaySize(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  if(!rect.width || !rect.height) return;
  canvas.width  = Math.round(rect.width  * dpr);
  canvas.height = Math.round(rect.height * dpr);
}

/* ===================== State and Cultural Presets ===================== */
const state = {
  v:-0.5, a:0.7,
  culture: "western",
  b0:0, bv:-0.8, ba:1.1, bva:0.9,
  bm:0.7, bg:0.6,
  bi:0.2,
  moral:0, out:0, in_:0,
  eta:1.2, kappa:0.6,
  v_weight:0.60,
  a_pref:0.20,
  a_sigma:0.60,
  lambda:1.0,
  N:220, kmean:10, nettype:"pa", seeds:10,
  gridw:80, gridh:50, tele:8,
  rho:0.7, gamma:0.2,
  speed:1.0, ss_thresh:0.80,
};
const culturalPresets = {
  western: { b0:0,  bv:-0.8, ba:1.1, bva:0.9, bm:0.7, bg:0.6, bi:0.2, eta:1.2, v_weight:0.60, a_pref:0.20, a_sigma:0.60, lambda:1.0 },
  eastern: { b0:0,  bv:+0.2, ba:1.0, bva:-0.1, bm:0.4, bg:0.3, bi:0.4, eta:1.1, v_weight:0.70, a_pref:0.40, a_sigma:0.50, lambda:1.2 },
  conflict: { b0:0.3,bv:-1.2, ba:1.4, bva:1.1, bm:0.9, bg:0.9, bi:0.1, eta:1.4, v_weight:0.45, a_pref:0.30, a_sigma:0.70, lambda:0.9 },
  science: { b0:0,  bv:+0.1, ba:0.9, bva:0.0, bm:0.3, bg:0.2, bi:0.2, eta:1.1, v_weight:0.75, a_pref:0.30, a_sigma:0.45, lambda:1.3 },
  spain_like_inparty: { b0:0,  bv:-0.2, ba:1.0, bva:0.4, bm:0.5, bg:0.2, bi:0.6, eta:1.15, v_weight:0.65, a_pref:0.30, a_sigma:0.55, lambda:1.1 }
};

/* ===================== Model Logic ===================== */
function shareProb(v,a, M=state.moral, Go=state.out, In=state.in_){
  const z = state.b0 + state.bv*v + state.ba*a + state.bva*v*a
          + (state.bm||0)*(M?1:0)
          + (state.bg||0)*(Go?1:0)
          + (state.bi||0)*(In?1:0);
  return 1/(1+Math.exp(-z));
}
function likeScore(v,a){
  const s_v = 0.5*(1+v);
  const s_a = Math.exp(- Math.pow(a - state.a_pref, 2) / (2*Math.pow(state.a_sigma,2)));
  const S   = clamp( 0.10 + state.v_weight*s_v + (1-state.v_weight)*s_a , 0, 1);
  return S;
}
function alphaPrime(v,a){ return state.eta * state.kappa * shareProb(v,a); }
function viralityParadoxScore(v,a){ return shareProb(v,a) * (1 - likeScore(v,a)); }
function E_eng(v,a){ return clamp(alphaPrime(v,a), 0, 1); }
function G_gap(v,a){ return E_eng(v,a) - state.lambda * likeScore(v,a); }

let updateTimer=null;
function scheduleUpdate(){ clearTimeout(updateTimer); updateTimer=setTimeout(()=>{ refreshAll(); }, 60); }
const stateProxy = new Proxy(state, {
  set(target, key, value){
    target[key] = value;
    const lab = el(key+"_val");
    if(lab){
      if(key==="speed") lab.textContent = Number(value).toFixed(1)+"×";
      else if(["N","kmean","seeds","gridw","gridh","tele"].includes(key)) lab.textContent = String(value);
      else lab.textContent = fmt(Number(value));
    }
    scheduleUpdate();
    return true;
  }
});

/* ===================== View Models ===================== */
const timers = { graph:null, evo:null, ca:null };

/* ----- Graph ----- */
const G = { nodes:[], links:[], adj:[], deg:[], Edeg:0, EK2:0, t:0,
            states:[], parent:[], infectedAt:[],
            seriesI:[], seriesC:[], chart:null,
            supers:[], supersSet:new Set(), contrib:[] };

function buildGraph(){
  const N = Math.floor(state.N);
  const k = Math.max(1, Math.floor(state.kmean/2));
  G.nodes = d3.range(N).map(i=>({id:i}));
  G.links = [];

  if(state.nettype==="er"){
    const p = state.kmean/(N-1);
    for(let i=0;i<N;i++)for(let j=i+1;j<N;j++){ if(rand.r()<p) G.links.push({source:i,target:j}); }
  }else{
    const m = Math.max(1,k);
    const deg = new Array(N).fill(0);
    G.links.push({source:0,target:1},{source:1,target:2},{source:2,target:0});
    deg[0]=deg[1]=deg[2]=2; let sum=6;
    for(let v=3;v<N;v++){
      const chosen=new Set();
      while(chosen.size<m){
        let r=rand.r()*sum, acc=0;
        for(let u=0;u<v;u++){ acc+=Math.max(1,deg[u]); if(acc>=r){ chosen.add(u); break; } }
      }
      chosen.forEach(u=>{ G.links.push({source:v,target:u}); deg[v]++; deg[u]++; sum+=2; });
    }
  }
  G.adj = d3.range(N).map(()=>[]);
  G.links.forEach(e=>{ G.adj[e.source].push(e.target); G.adj[e.target].push(e.source); });
  G.deg = G.adj.map(nei=>nei.length);
  G.Edeg = d3.mean(G.deg); G.EK2 = d3.mean(G.deg.map(d=>d*d));

  G.states = new Array(N).fill(0);
  G.parent = new Array(N).fill(-1);
  G.infectedAt = new Array(N).fill(Infinity);
  const seeds = Math.min(state.seeds,N);
  d3.shuffle(d3.range(N)).slice(0,seeds).forEach(i=>{ G.states[i]=2; G.infectedAt[i]=0; });
  G.t=0; G.seriesI=[seeds]; G.seriesC=[seeds];
  computeSupers();         // initial
  drawGraph(); drawTree(); initGraphChart(); refreshGraphMetrics();
}
function expectedR0(){
  const ap = alphaPrime(state.v,state.a);
  return ap * (G.EK2 - G.Edeg) / Math.max(1e-6,G.Edeg);
}

/* Superspreader detection */
function calculateNodeContributions(){
  const N=G.nodes.length; const contrib=new Array(N).fill(0);
  for(let i=0;i<N;i++){ const p=G.parent[i]; if(p>=0) contrib[p]++; }
  return contrib;
}
function identifySuperspreaders(threshold){
  const contrib = calculateNodeContributions();
  const total = contrib.reduce((a,b)=>a+b,0);
  G.contrib = contrib;
  if(total===0) return [];
  const idx = contrib.map((v,i)=>({i,v})).filter(d=>d.v>0)
                   .sort((a,b)=>b.v-a.v);
  let cum=0; const out=[];
  for(const d of idx){ cum += d.v; out.push(d.i); if(cum/total >= threshold) break; }
  return out;
}
function computeSupers(){
  G.supers = identifySuperspreaders(state.ss_thresh);
  G.supersSet = new Set(G.supers);
}

/* Graph Drawing */
let graphSVG = d3.select("#graphSVG"), treeSVG=d3.select("#treeSVG"), simForce=null;
function drawGraph(){
  const W = graphSVG.node().clientWidth || 720, H = graphSVG.node().clientHeight || 470;
  graphSVG.attr("width",W).attr("height",H).selectAll("*").remove();

  const link = graphSVG.append("g").selectAll("line")
    .data(G.links).enter().append("line")
    .attr("stroke","#24304e").attr("stroke-opacity",0.6);

  const nodes = graphSVG.append("g").selectAll("circle")
    .data(G.nodes).enter().append("circle")
    .attr("r", d=> 3 + 0.4*G.deg[d.id])
    .attr("stroke","#0e1320").attr("stroke-width",0.8)
    .append("title");

  simForce = d3.forceSimulation(G.nodes)
    .force("link", d3.forceLink(G.links).id(d=>d.id).distance(30).strength(0.05))
    .force("charge", d3.forceManyBody().strength(-30))
    .force("center", d3.forceCenter(W/2,H/2))
    .on("tick", ()=>{
      graphSVG.selectAll("line")
        .attr("x1",d=>d.source.x).attr("y1",d=>d.source.y)
        .attr("x2",d=>d.target.x).attr("y2",d=>d.target.y);
      const color = s => s===0?"#7f8ca399": s===1?"#69b3ff": s===2?"#ffd166":"#ff6b6b";
      graphSVG.selectAll("circle")
        .attr("cx",d=>d.x).attr("cy",d=>d.y)
        .attr("fill", d=> color(G.states[d.id]))
        .attr("stroke", d=> G.supersSet.has(d.id) ? "#9bf6a5" : "#0e1320")
        .attr("stroke-width", d=> G.supersSet.has(d.id) ? 2.5 : 0.8)
        .select("title")
        .text(d=>`Node ${d.id}\ndeg=${G.deg[d.id]}\nstate=${["S","E","I","R"][G.states[d.id]]}\ntAct=${G.infectedAt[d.id]===Infinity?"–":G.infectedAt[d.id]}\ncontrib=${G.contrib[d.id]||0}${G.supersSet.has(d.id)?"  (SUPER)":""}`);
    });
}
function drawTree(){
  const W = treeSVG.node().clientWidth || 420, H = treeSVG.node().clientHeight || 470;
  treeSVG.attr("width",W).attr("height",H).selectAll("*").remove();
  const active = d3.range(G.nodes.length).filter(i=>G.infectedAt[i]!==Infinity);
  const byT = d3.group(active, i=>G.infectedAt[i]);
  const times = Array.from(byT.keys()).sort((a,b)=>a-b);
  const colW = Math.max(40, W/Math.max(1,times.length+1));
  const pos = new Map();
  times.forEach((t,ti)=>{
    const arr = byT.get(t)||[];
    const yStep = H/(arr.length+1);
    arr.forEach((n,idx)=> pos.set(n,{x:(ti+1)*colW, y:(idx+1)*yStep}) );
  });
  treeSVG.append("g").selectAll("path")
    .data(active.filter(i=>G.parent[i]>=0)).enter()
    .append("path")
    .attr("d", d=>{
      const p = pos.get(d), q = pos.get(G.parent[d]);
      if(!p||!q) return "";
      return `M${q.x},${q.y} C ${q.x+20},${q.y} ${p.x-20},${p.y} ${p.x},${p.y}`;
    })
    .attr("fill","none").attr("stroke",d=> G.supersSet.has(G.parent[d])?"#9bf6a5":"#2b3a5e")
    .attr("stroke-width", d=> G.supersSet.has(G.parent[d])?2:1);
  treeSVG.append("g").selectAll("circle")
    .data(active).enter().append("circle")
    .attr("cx", d=>pos.get(d)?.x||10).attr("cy", d=>pos.get(d)?.y||10).attr("r",4)
    .attr("fill", d=> G.supersSet.has(d) ? "#9bf6a5" : "#9bb2ff");
}

/* Graph Dynamics */
function graphStep(){
  const N=G.nodes.length, ap=alphaPrime(state.v,state.a);
  const next = G.states.slice(); const newI=[];
  for(let j=0;j<N;j++){
    if(G.states[j]!==0) continue;
    const kI = G.adj[j].reduce((acc,u)=> acc + (G.states[u]===2?1:0), 0);
    const pSE = 1 - Math.pow(1-ap, kI);
    if(rand.r()<pSE){ next[j]=1;
      const cand = G.adj[j].filter(u=>G.states[u]===2);
      if(cand.length>0) G.parent[j]= cand[Math.floor(rand.r()*cand.length)];
      if(G.infectedAt[j]===Infinity) G.infectedAt[j]=G.t+1;
    }
  }
  for(let j=0;j<N;j++){ if(G.states[j]===1 && rand.r()<state.rho){ next[j]=2; newI.push(j); } }
  for(let j=0;j<N;j++){ if(G.states[j]===2 && rand.r()<state.gamma){ next[j]=3; } }
  G.states = next; G.t++;
  const I = G.states.filter(s=>s===2).length;
  const C = G.states.filter(s=>s!==0).length;
  G.seriesI.push(I); G.seriesC.push(C);
  computeSupers();
  drawGraph(); drawTree(); updateGraphChart(); refreshGraphMetrics();
}
function refreshGraphMetrics(){
  const R0 = expectedR0(), ap=alphaPrime(state.v,state.a), vps=viralityParadoxScore(state.v,state.a);
  const I = G.seriesI.length ? G.seriesI[G.seriesI.length-1] : 0;
  const C = G.seriesC.length ? G.seriesC[G.seriesC.length-1] : 0;
  const total = (G.contrib||[]).reduce((a,b)=>a+b,0) || 1;
  const top = (G.contrib||[]).map((v,i)=>({i,v})).filter(d=>d.v>0).sort((a,b)=>b.v-a.v).slice(0,5);

  el("metrics").innerHTML = `
    <div class="row" style="gap:8px; flex-wrap:wrap">
      <div class="badge">Culture: ${state.culture}</div>
      <div class="badge">t=${G.t}</div> <div class="badge">I(t)=${I}</div> <div class="badge">C(t)=${C}</div>
      <div class="badge">M=${state.moral?1:0}</div> <div class="badge">Out=${state.out?1:0}</div> <div class="badge">In=${state.in_?1:0}</div>
      <div class="badge">α′=${fmt(ap)}</div> <div class="badge">R₀≈${fmt(R0)}</div> <div class="badge">VPS≈${fmt(vps)}</div>
      <div class="badge">#Supers=${G.supers.length}</div>
    </div>
    <div class="metric" style="margin-top:6px">
      <b>Top superspreaders</b>: ${ top.length? top.map(d=>`#${d.i} (${fmt(100*d.v/total,1)}%)`).join(" · ") : "—" }
    </div>
    <div class="metric" style="margin-top:6px">
      <b>Degrees</b>: E[K]=${fmt(G.Edeg)} · E[K²]=${fmt(G.EK2)} · Seeds=${state.seeds}
    </div>`;
}
/* Chart I/C */
function initGraphChart(){
  const ctx = el("chartGI").getContext("2d");
  if(G.chart) G.chart.destroy();
  G.chart = new Chart(ctx, { type:"line",
    data:{ labels:[0],
      datasets:[ {label:"I(t)", data:[G.seriesI[0]], borderWidth:2, tension:0.25}, {label:"C(t)", data:[G.seriesC[0]], borderWidth:2, tension:0.25} ]},
    options:{ responsive:true, animation:false, scales:{ x:{ticks:{color:"#9aa4b2"}}, y:{ticks:{color:"#9aa4b2"}}}, plugins:{ legend:{labels:{color:"#c9d3f2"}}}}
  });
}
function updateGraphChart(){
  const L = G.seriesI.length;
  G.chart.data.labels = d3.range(L);
  G.chart.data.datasets[0].data = G.seriesI;
  G.chart.data.datasets[1].data = G.seriesC;
  G.chart.update();
}

/* ----- Evolutionary ----- */
const EVO = { pop:[], gen:0, fronts:[], chart:null, eliteTrace:[] };
function evoInit(){
  EVO.gen=0; EVO.eliteTrace=[];
  EVO.pop = d3.range(120).map(()=>({ v:-1+2*rand.r(), a:-1+2*rand.r(), F1:0, F2:0 }));
  evoEval(); evoDraw(); initParetoChart(); updateEvoMetrics();
}
function evoEval(){
  EVO.pop.forEach(p=>{
    const ap = alphaPrime(p.v,p.a);
    const deg = G.Edeg||Math.max(1,state.kmean);
    const k2  = G.EK2 || ((deg+2)*deg);
    const R0 = ap*(k2-deg)/Math.max(1e-6,deg);
    const size = 1/(1+Math.exp(-4*(R0-1)));
    p.F1 = size; p.F2 = -G_gap(p.v,p.a);
  });
  EVO.fronts = EVO.pop.filter(p=>{
    return !EVO.pop.some(q => (q!==p) && (q.F1>=p.F1 && q.F2>=p.F2) && (q.F1>p.F1 || q.F2>p.F2));
  });
  const best = EVO.pop.slice().sort((a,b)=>(b.F1+b.F2)-(a.F1+a.F2))[0];
  EVO.eliteTrace.push({v:best.v,a:best.a});
}
function evoNextGen(){
  function pick(){ return EVO.pop[Math.floor(rand.r()*EVO.pop.length)]; }
  const children=[];
  while(children.length<EVO.pop.length){
    const a=pick(), b=pick(), c=pick(), d=pick();
    const p1 = ((a.F1+a.F2)>(b.F1+b.F2))? a:b;
    const p2 = ((c.F1+c.F2)>(d.F1+d.F2))? c:d;
    const w = rand.r();
    let v = w*p1.v + (1-w)*p2.v; let A = w*p1.a + (1-w)*p2.a;
    v += (rand.r()-0.5)*0.2; A += (rand.r()-0.5)*0.2;
    children.push({v:clamp(v,-1,1), a:clamp(A,-1,1), F1:0, F2:0});
  }
  EVO.pop = children; EVO.gen++; evoEval(); evoDraw(); updateParetoChart(); updateEvoMetrics();
}
function evoDraw(){
  const svg = d3.select("#evoSVG");
  const W = svg.node().clientWidth || 900, H = svg.node().clientHeight || 470;
  svg.attr("width",W).attr("height",H).selectAll("*").remove();
  const x = d3.scaleLinear().domain([-1,1]).range([40,W-20]);
  const y = d3.scaleLinear().domain([-1,1]).range([H-30,20]);
  svg.append("g").attr("transform",`translate(0,${H-30})`).call(d3.axisBottom(x)).selectAll("text").attr("fill","#b8c1d9");
  svg.append("g").attr("transform","translate(40,0)").call(d3.axisLeft(y)).selectAll("text").attr("fill","#b8c1d9");
  svg.selectAll(".domain,.tick line").attr("stroke","#2b3554");
  svg.append("g").selectAll("circle").data(EVO.pop).enter().append("circle")
     .attr("cx",d=>x(d.v)).attr("cy",d=>y(d.a)).attr("r",3.5)
     .attr("fill","#5db1ff").attr("opacity",0.65)
     .append("title").text(d=>`v=${fmt(d.v)} a=${fmt(d.a)} F1=${fmt(d.F1)} F2=${fmt(d.F2)}`);
  svg.append("g").selectAll("circle").data(EVO.fronts).enter().append("circle")
     .attr("cx",d=>x(d.v)).attr("cy",d=>y(d.a)).attr("r",5)
     .attr("fill","#ffd166").attr("stroke","#0e1320");
  if(EVO.eliteTrace.length>1){
    const line = d3.line().x(d=>x(d.v)).y(d=>y(d.a)).curve(d3.curveCatmullRom.alpha(0.6));
    svg.append("path").datum(EVO.eliteTrace)
      .attr("d", line).attr("fill","none").attr("stroke","#9bf6a5").attr("stroke-width",2);
  }
  svg.append("circle").attr("cx",x(state.v)).attr("cy",y(state.a)).attr("r",6)
     .attr("fill","none").attr("stroke","#ff6b6b").attr("stroke-width",2);
}
function updateEvoMetrics(){
  const ap = alphaPrime(state.v,state.a), R0 = expectedR0();
  const F1 = 1/(1+Math.exp(-4*(R0-1))), F2 = -G_gap(state.v,state.a);
  el("e_metrics").innerHTML = `
    <div class="row" style="gap:12px; flex-wrap:wrap">
      <div class="badge">Culture: ${state.culture}</div> <div class="badge">Gen=${EVO.gen}</div>
      <div class="badge">α′=${fmt(ap)}</div> <div class="badge">R₀≈${fmt(R0)}</div>
      <div class="badge">F₁≈${fmt(F1)}</div> <div class="badge">F₂≈${fmt(F2)}</div>
      <div class="badge">Pareto: ${EVO.fronts.length} points</div>
    </div>`;
}
function initParetoChart(){
  const ctx = el("chartPareto").getContext("2d");
  if(EVO.chart) EVO.chart.destroy();
  EVO.chart = new Chart(ctx, { type:"line",
    data:{ labels:[0], datasets:[ {label:"|Pareto|", data:[0], borderWidth:2, tension:0.25}, {label:"F₁ elite", data:[0], borderWidth:2, tension:0.25} ]},
    options:{ responsive:true, animation:false, scales:{ x:{ticks:{color:"#9aa4b2"}}, y:{ticks:{color:"#9aa4b2"}}}, plugins:{ legend:{labels:{color:"#c9d3f2"}}}}
  });
  updateParetoChart();
}
function updateParetoChart(){
  const best = EVO.pop.slice().sort((a,b)=>(b.F1+b.F2)-(a.F1+a.F2))[0] || {F1:0};
  EVO.chart.data.labels.push(EVO.gen);
  EVO.chart.data.datasets[0].data.push(EVO.fronts.length);
  EVO.chart.data.datasets[1].data.push(best.F1);
  EVO.chart.update();
}

/* ----- Automaton ----- */
const CA = { W:80, H:50, grid:[], t:0, series:{S:[],E:[],I:[],R:[]}, chart:null };
function caInit(){
  CA.W = Math.floor(state.gridw); CA.H=Math.floor(state.gridh);
  CA.grid = new Array(CA.W*CA.H).fill(0);
  for(let s=0;s<10;s++){ CA.grid[Math.floor(rand.r()*CA.grid.length)] = 2; }
  CA.t=0; CA.series={S:[],E:[],I:[],R:[]};
  caMeasure(); caDraw(); initCAChart(); updateCAChart();
}
function idx(x,y){ return y*CA.W+x; }
function neighborsI(x,y){
  let c=0;
  for(let dx=-1;dx<=1;dx++) for(let dy=-1;dy<=1;dy++){
    if(dx===0 && dy===0) continue;
    const nx=x+dx, ny=y+dy;
    if(nx>=0 && nx<CA.W && ny>=0 && ny<CA.H) if(CA.grid[idx(nx,ny)]===2) c++;
  } return c;
}
function caStep(){
  const ap = alphaPrime(state.v,state.a);
  const next = CA.grid.slice();
  const T = Math.floor(state.tele);
  for(let t=0;t<T;t++){ const j=Math.floor(rand.r()*CA.grid.length); if(next[j]===0) next[j]=1; }
  for(let y=0;y<CA.H;y++) for(let x=0;x<CA.W;x++){
    const i=idx(x,y), s=CA.grid[i];
    if(s===0){ const kI=neighborsI(x,y); const p=1-Math.pow(1-ap,kI); if(rand.r()<p) next[i]=1; }
    else if(s===1){ if(rand.r()<state.rho) next[i]=2; }
    else if(s===2){ if(rand.r()<state.gamma) next[i]=3; }
  }
  CA.grid=next; CA.t++; caMeasure(); caDraw(); updateCAChart();
}
function caMeasure(){
  const c=[0,0,0,0]; for(const s of CA.grid) c[s]++;
  CA.series.S.push(c[0]); CA.series.E.push(c[1]); CA.series.I.push(c[2]); CA.series.R.push(c[3]);
}
function caDraw(){
  const cnv = el("gridCanvas"); resizeCanvasToDisplaySize(cnv);
  const ctx = cnv.getContext("2d");
  const {width:W, height:H} = cnv;
  const cw = Math.max(1, Math.floor(W/(CA.W))), ch = Math.max(1, Math.floor(H/(CA.H)));
  ctx.fillStyle="#0e1320"; ctx.fillRect(0,0,W,H);
  for(let y=0;y<CA.H;y++) for(let x=0;x<CA.W;x++){
    const s=CA.grid[idx(x,y)];
    ctx.fillStyle = s===0?"#7f8ca333": s===1?"#69b3ff": s===2?"#ffd166":"#ff6b6b";
    ctx.fillRect(Math.floor(x*cw), Math.floor(y*ch), cw-1, ch-1);
  }
}
function initCAChart(){
  const ctx = el("chartSER").getContext("2d");
  if(CA.chart) CA.chart.destroy();
  CA.chart = new Chart(ctx,{ type:"line",
    data:{ labels:[0],
      datasets:[ {label:"S", data:[CA.series.S[0]], borderWidth:2, tension:0.25}, {label:"E", data:[CA.series.E[0]], borderWidth:2, tension:0.25}, {label:"I", data:[CA.series.I[0]], borderWidth:2, tension:0.25}, {label:"R", data:[CA.series.R[0]], borderWidth:2, tension:0.25} ]},
    options:{ responsive:true, animation:false, scales:{ x:{ticks:{color:"#9aa4b2"}}, y:{ticks:{color:"#9aa4b2"}}}, plugins:{ legend:{labels:{color:"#c9d3f2"}}}}
  });
}
function updateCAChart(){
  const L = CA.series.S.length;
  CA.chart.data.labels = d3.range(L);
  CA.chart.data.datasets[0].data = CA.series.S;
  CA.chart.data.datasets[1].data = CA.series.E;
  CA.chart.data.datasets[2].data = CA.series.I;
  CA.chart.data.datasets[3].data = CA.series.R;
  CA.chart.update();
}

/* ===================== UI / Timers / Initialization ===================== */
function stopAllTimers(){ for(const k of Object.keys(timers)){ if(timers[k]){ clearInterval(timers[k]); timers[k]=null; } } }

function applyCulturePreset(name){
  const P = culturalPresets[name]; if(!P) return;
  ["b0","bv","ba","bva","bm","bg","bi","eta","v_weight","a_pref","a_sigma","lambda"]
    .forEach(k=>{
      const s = el(k);
      if(s){ s.value = P[k]; state[k] = Number(P[k]); 
             const valSpan = s.parentElement.querySelector('.value');
             if(valSpan) valSpan.textContent = (+P[k]).toFixed(2);
      }
    });
  state.culture = name;
  refreshAll();
}

function bindUI(){
  const ids = ["v","a","b0","bv","ba","bva","bm","bg","bi",
             "moral","out","in_","culture",
             "eta","kappa","lambda","v_weight","a_pref","a_sigma",
             "N","kmean","nettype","seeds","gridw","gridh","tele",
             "rho","gamma","speed","ss_thresh"];

  ids.forEach(id=>{
    const s = el(id); if(!s) return;
    const write = ()=>{
      const val = (s.type==="range") ? Number(s.value) : (s.type==="checkbox") ? Number(s.checked) : s.value;
      stateProxy[id] = val;
      if(id === "culture"){ applyCulturePreset(val); }
    };
    s.addEventListener("input", write);
    if(id !== "culture") write(); // Avoid double initial call for culture
  });

  // Tabs
  document.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click", ()=>{
      document.querySelectorAll(".tab").forEach(x=>x.classList.remove("active"));
      t.classList.add("active");
      document.querySelectorAll(".view").forEach(v=>v.classList.remove("active"));
      el("view-"+t.dataset.tab).classList.add("active");
      refreshAll();
    });
  });

  // Control Buttons
  el("g_play").addEventListener("click", ()=>{ if(!timers.graph){ graphStep(); timers.graph=setInterval(graphStep, Math.max(60, 400/state.speed)); }});
  el("g_pause").addEventListener("click", ()=>{ if(timers.graph){ clearInterval(timers.graph); timers.graph=null; } });
  el("g_step").addEventListener("click", graphStep);
  el("g_reset").addEventListener("click", ()=>{ if(timers.graph){ clearInterval(timers.graph); timers.graph=null; } buildGraph(); });
  el("e_run").addEventListener("click", ()=>{ if(!timers.evo){ evoNextGen(); timers.evo=setInterval(evoNextGen, Math.max(80, 600/state.speed)); }});
  el("e_pause").addEventListener("click", ()=>{ if(timers.evo){ clearInterval(timers.evo); timers.evo=null; } });
  el("e_step").addEventListener("click", evoNextGen);
  el("e_reset").addEventListener("click", ()=>{ if(timers.evo){ clearInterval(timers.evo); timers.evo=null; } evoInit(); });
  el("c_play").addEventListener("click", ()=>{ if(!timers.ca){ caStep(); timers.ca=setInterval(caStep, Math.max(50, 200/state.speed)); }});
  el("c_pause").addEventListener("click", ()=>{ if(timers.ca){ clearInterval(timers.ca); timers.ca=null; } });
  el("c_step").addEventListener("click", caStep);
  el("c_reset").addEventListener("click", ()=>{ if(timers.ca){ clearInterval(timers.ca); timers.ca=null; } caInit(); });
  
  el("regen").addEventListener("click", ()=>{ stopAllTimers(); buildGraph(); });
  el("resetAll").addEventListener("click", ()=>{ stopAllTimers(); buildGraph(); evoInit(); caInit(); });

  let rto=null;
  window.addEventListener("resize", ()=>{ clearTimeout(rto); rto=setTimeout(()=>{ refreshAll(); },150); });
}

function refreshAll(){
  computeSupers();
  drawGraph(); drawTree(); updateGraphChart(); refreshGraphMetrics();
  evoDraw(); updateParetoChart(); updateEvoMetrics();
  caDraw(); updateCAChart();
}

async function initializeApp(){
  if(window.MathJax && MathJax.typesetPromise){ await MathJax.typesetPromise(); }
  bindUI();
  rand.seed(1234567);
  applyCulturePreset(state.culture);
  buildGraph(); evoInit(); caInit();
}

window.addEventListener('load', initializeApp);
</script>
</body>
</html>